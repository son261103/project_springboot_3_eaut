<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout Page</title>
    <style>
        /* Add basic styling for the checkout page */
        .container {
            width: 80%;
            margin: auto;
            padding: 20px;
        }
        .order-summary {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
        }
        .order-summary p, .order-summary ul {
            margin: 0;
            padding: 0;
        }
        .order-summary ul {
            list-style-type: none;
        }
        #payment-form {
            margin-top: 20px;
        }
        #submit-payment-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Checkout</h1>
    <div class="order-summary" id="order-info">
        <p>Loading order information...</p>
    </div>
    <div id="payment-form">
        <h2>Payment Information</h2>
        <!-- Include payment form inputs here -->
        <label for="card-number">Card Number:</label>
        <input type="text" id="card-number" name="card-number" required><br>
        <label for="expiry-date">Expiry Date:</label>
        <input type="text" id="expiry-date" name="expiry-date" placeholder="MM/YY" required><br>
        <label for="cvv">CVV:</label>
        <input type="text" id="cvv" name="cvv" required><br>
        <button id="submit-payment-btn">Submit Payment</button>
    </div>
</div>

<script>
    function getCartFromSession() {
        var cart = sessionStorage.getItem("cart");
        if (cart) {
            try {
                var cartData = JSON.parse(cart);
                return cartData;
            } catch (e) {
                console.error("Invalid cart data in sessionStorage. Resetting cart.");
                sessionStorage.removeItem("cart");
                return null;
            }
        }
        return null;
    }

    function isValidJSON(str) {
        try {
            JSON.parse(str);
            return true;
        } catch (e) {
            return false;
        }
    }

    function sendCheckoutRequest() {
        var cart = sessionStorage.getItem("cart");
        console.log("Cart data in sessionStorage:", cart); // Log cart data

        if (cart) {
            if (isValidJSON(cart)) {
                var cartItems = JSON.parse(cart);
                if (Array.isArray(cartItems) && cartItems.length > 0) {
                    var cartRequest = {
                        items: cartItems
                    };

                    fetch('/users/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(cartRequest)
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error('Checkout failed');
                            }
                        })
                        .then(data => {
                            displayOrderSummary(data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            document.getElementById("order-info").innerHTML = '<p>An error occurred. Please try again.</p>';
                        });
                } else {
                    console.error("Empty or invalid cart.");
                    document.getElementById("order-info").innerHTML = '<p>Invalid cart data. Please try again.</p>';
                }
            } else {
                console.error("Invalid cart data in sessionStorage.");
                document.getElementById("order-info").innerHTML = '<p>Invalid cart data. Please try again.</p>';
            }
        } else {
            console.log("No items in the cart.");
            document.getElementById("order-info").innerHTML = '<p>No items in cart.</p>';
        }
    }

    function displayOrderSummary(data) {
        var orderInfo = document.getElementById("order-info");
        orderInfo.innerHTML = '';

        var summary = document.createElement('div');
        summary.innerHTML = '<h2>Order Summary</h2>';

        var itemList = document.createElement('ul');
        data.items.forEach(function(item) {
            var itemElement = document.createElement('li');
            itemElement.textContent = item.name + ' - Quantity: ' + item.quantity + ' - Price: $' + item.price.toFixed(2);
            itemList.appendChild(itemElement);
        });

        summary.appendChild(itemList);

        var totalAmount = document.createElement('p');
        totalAmount.textContent = 'Total Amount: $' + data.totalAmount.toFixed(2);
        summary.appendChild(totalAmount);

        orderInfo.appendChild(summary);
    }

    function submitPayment() {
        // Collect payment information from the form and send it to the server
        var paymentData = {
            // Include payment data here, such as credit card information, billing
            cardNumber: document.getElementById('card-number').value,
            expiryDate: document.getElementById('expiry-date').value,
            cvv: document.getElementById('cvv').value
        };

        fetch('/users/process-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentData)
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Payment processing failed');
                }
            })
            .then(data => {
                console.log('Payment successful:', data);
                alert('Payment successful!'); // You can customize this message
                // Redirect or perform any other actions after successful payment
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Payment failed. Please try again.'); // You can customize this message
            });
    }

    document.getElementById('submit-payment-btn').addEventListener('click', submitPayment);

    // Initial cart data loading and display
    var cart = getCartFromSession();
    if (cart) {
        displayOrderSummary({ items: cart, totalAmount: cart.reduce((total, item) => total + (item.price * item.quantity), 0) });
    } else {
        document.getElementById("order-info").innerHTML = '<p>No items in cart.</p>';
    }
</script>
</body>
</html>
